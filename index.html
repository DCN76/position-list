<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vessel Data Manager (Position & Setup)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for better aesthetics and interaction in DARK MODE */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background: bg-gray-900 */
            color: #d1d5db; /* Default light text: text-gray-300 */
        }
        /* Custom styling for the details/summary element to look like a row */
        details.ship-row {
            margin-bottom: 0.5rem;
            border-radius: 0.75rem; /* rounded corners */
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); /* Darker shadow for contrast */
            transition: all 0.2s ease-in-out;
        }
        /* Style the summary to act as the main clickable header */
        details summary {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            cursor: pointer;
            background-color: #1f2937; /* Dark element background: bg-gray-800 */
            font-weight: 600;
            color: #f3f4f6; /* Light text */
            list-style: none; /* Hide default triangle */
        }

        /* Re-add a custom toggle icon */
        details summary::-webkit-details-marker {
            display: none;
        }
        details summary:after {
            content: 'â–¼';
            margin-left: auto;
            transition: transform 0.2s ease;
            font-size: 0.75rem;
            color: #9ca3af; /* Light gray icon */
        }
        details[open] summary:after {
            transform: rotate(180deg);
        }
        details[open] {
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.3);
        }

        /* Itinerary container */
        .itinerary-container {
            padding: 1rem 1.5rem 1.5rem;
            background-color: #374151; /* Slightly lighter dark background: bg-gray-700 */
            border-top: 1px solid #4b5563; /* Darker border: border-gray-600 */
        }

        /* Responsive table styling */
        .itinerary-table th, .itinerary-table td {
            padding: 0.75rem 1rem;
            text-align: left;
        }
        .itinerary-table th {
            color: #d1d5db; /* Light header text: text-gray-300 */
            font-weight: 600;
            background-color: #4f46e550; /* Lightly transparent indigo header: bg-indigo-700/50 */
        }
        .itinerary-table td {
            color: #e5e7eb; /* Very light cell text: text-gray-200 */
            border-bottom: 1px solid #4b5563; /* Darker bottom border: border-gray-600 */
        }
        .itinerary-table tr:last-child td {
            border-bottom: none;
        }
        
        /* Style for inputs inside the table */
        .itinerary-table input[type="text"] {
            border: 1px solid #4b5563;
            background-color: #1f2937; /* Dark input background: bg-gray-800 */
            color: #f3f4f6; /* Light input text */
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            width: 100%;
            transition: all 0.1s;
        }
        .itinerary-table input[type="text"]:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 1px #6366f1;
            outline: none;
        }
        
        /* Password prompt styling */
        .password-prompt-small {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            padding: 0.5rem;
            background-color: #3f3f46; /* bg-zinc-700 */
            border-radius: 0.5rem;
            border: 1px solid #4b5563; /* adjusted border for dark mode */
            margin-bottom: 1rem;
        }

        /* Mobile layout for itinerary table */
        @media (max-width: 768px) {
            .itinerary-table {
                border: 1px solid #4b5563;
            }
            .itinerary-table tr {
                background-color: #1f2937; /* Dark background for mobile rows */
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            }
            .itinerary-table td::before {
                color: #f3f4f6; /* Light label text */
            }
        }

    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Combined Title and Nav Row -->
        <div class="flex justify-between items-end border-b-2 border-indigo-400 pb-2 mb-6">
            <h1 class="text-3xl font-bold text-gray-100">
                Vessel Data Manager
            </h1>

            <!-- Navigation Tabs -->
            <div id="app-nav" class="flex space-x-4">
                <button id="nav-position-list" onclick="switchView('position-list')" class="nav-tab pb-3 font-semibold transition duration-150">
                    Position List
                </button>
                <button id="nav-settings" onclick="switchView('settings')" class="nav-tab pb-3 font-semibold transition duration-150">
                    Setup / Settings
                </button>
            </div>
        </div>

        <!-- POSITION LIST VIEW (Default) -->
        <div id="position-list-view">
            <h2 class="text-2xl font-bold text-gray-100 mb-4">Global Vessel Positions</h2>
            <div id="ship-list" class="space-y-3">
                <!-- Ship rows will be rendered here by JavaScript -->
                <p class="text-gray-400" id="loading-message">
                    <span id="loading-text">Connecting to Database...</span>
                </p>
            </div>
        </div>

        <!-- SETTINGS VIEW (Initially hidden) -->
        <div id="settings-view" class="hidden">
            <h2 class="text-2xl font-bold text-gray-100 mb-4">Application Settings</h2>
            
            <div class="space-y-8 p-6 bg-gray-800 rounded-xl shadow-lg">

                <!-- Section 1: Local Edit Key -->
                <div>
                    <h3 class="text-xl font-semibold text-indigo-400 mb-3 border-b border-gray-700 pb-2">Itinerary Editing Access</h3>
                    <p class="text-gray-400 mb-4 text-sm">
                        The **Local Edit Key** controls access to itinerary editing for demonstration purposes. Key must be 5 digits.
                    </p>
                    <div class="flex flex-col space-y-4 max-w-sm">
                        <div class="flex items-center space-x-4">
                            <span class="text-lg font-mono bg-gray-900 text-yellow-300 p-2 rounded-lg border border-gray-700">
                                Current Key: <span id="display-local-key"></span>
                            </span>
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="new-key-input" placeholder="Enter new 5-digit key" maxlength="5" class="px-3 py-2 text-sm flex-grow rounded-lg border border-gray-700 bg-gray-900 text-white focus:ring-indigo-500 focus:border-indigo-500">
                            <button onclick="changeLocalEditKey()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-150 text-sm font-semibold">
                                Set Key
                            </button>
                        </div>
                        <p id="key-change-message" class="mt-2 text-sm h-5"></p>
                    </div>
                </div>

                <!-- Section 2: Data Management -->
                <div>
                    <h3 class="text-xl font-semibold text-indigo-400 mb-3 border-b border-gray-700 pb-2">Data Management (Database Operations)</h3>
                    <p class="text-gray-400 mb-4 text-sm">
                        This action will overwrite the current live database data with the original default data set.
                    </p>
                    <button onclick="resetShipData()" class="bg-red-700 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-600 transition duration-150 shadow-md">
                        Reset All Itineraries (Restore Defaults in DB)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports (Module type required for ES modules) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Use Debug logging to see detailed Firestore operations
        setLogLevel('Debug');

        // --- GLOBAL INITIALIZATION ---
        
        // Access global environment variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Export globally needed variables for non-module script access
        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.shipData = []; // Data will be loaded here from Firestore
        
        // EXPORT Firestore utilities needed by global functions (saveItinerary, resetShipData)
        window.doc = doc;
        window.setDoc = setDoc;
        window.writeBatch = writeBatch;
        
        // --- AUTHENTICATION AND SETUP ---

        /**
         * Authenticates the user using the provided custom token or anonymously.
         */
        async function authenticateUser() {
            try {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                // Once authenticated, the auth listener will pick it up and proceed
            } catch (error) {
                console.error("Firebase Authentication Error:", error);
                // FIX: Check if the element exists before trying to set textContent
                const loadingText = document.getElementById('loading-text');
                if (loadingText) {
                    loadingText.textContent = "Authentication Failed. See console for details.";
                }
            }
        }
        
        /**
         * Sets up the real-time data listener once the user is authenticated.
         */
        function setupDataListener() {
            const dataPath = `artifacts/${appId}/public/data/vessels`;
            const q = collection(db, dataPath);

            // Real-time listener for all vessels
            onSnapshot(q, (querySnapshot) => {
                const loadedShips = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Ensure the IMO is correctly set from the document ID
                    data.imo = doc.id; 
                    loadedShips.push(data);
                });
                
                // Sort by IMO for consistent display
                window.shipData = loadedShips.sort((a, b) => a.imo.localeCompare(b.imo));

                // Update UI based on loaded data
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) {
                    loadingMessage.classList.add('hidden');
                }
                
                // Only re-render if we are on the position list page
                if (window.currentPage === 'position-list') {
                    // Use the globally exposed render function
                    window.renderShipList(window.lastOpenImo);
                }
            }, (error) => {
                console.error("Firestore Snapshot Listener Error:", error);
                // FIX: Check if the element exists before trying to set textContent
                const loadingText = document.getElementById('loading-text');
                if (loadingText) {
                    loadingText.textContent = "Failed to load data from Firestore.";
                }
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) {
                    loadingMessage.classList.remove('hidden');
                }
            });
        }

        // Auth State Listener: Start data listeners only after auth is ready
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User authenticated:", user.uid);
                window.userId = user.uid;
                // FIX: Check if the element exists before trying to set textContent
                const loadingText = document.getElementById('loading-text');
                if (loadingText) {
                    loadingText.textContent = "Loading vessel data...";
                }
                setupDataListener();
            } else {
                // User logged out or initial state check complete
            }
        });

        // Start the authentication process
        authenticateUser();
        
    </script>


    <script>
        // --- CONSTANTS AND STATE ---
        const LOCAL_EDIT_KEY_DEFAULT = "11111"; // Default key for initial unlock

        // Initialize a mutable global property for the current key
        window.currentEditKey = LOCAL_EDIT_KEY_DEFAULT;

        // Tracks unlocked state per ship IMO (in-memory, non-persistent)
        window.unlockedShips = {}; 
        window.lastOpenImo = null; // Track the last opened IMO to re-open it on re-render
        
        // Original default data (used for database reset)
        const originalShipData = [
            {
                name: "MSC Gaia",
                imo: "9832721",
                status: "At Sea (En Route)",
                destination: "Valencia, Spain",
                itinerary: [
                    { port: "Jebel Ali", eta: "2025-11-10", etd: "2025-11-12", agent: "Sealink Global", comments: "Heavy container offload" },
                    { port: "Dammam", eta: "2025-11-13", etd: "2025-11-14", agent: "Horizon Marine", comments: "Fuel bunkering scheduled" },
                    { port: "Suez Canal", eta: "2025-11-16", etd: "2025-11-16", agent: "Canal Transit Auth", comments: "Priority convoy slot (Southbound)" },
                    { port: "Piraeus", eta: "2025-11-20", etd: "2025-11-21", agent: "Aegean Ports", comments: "Crew change operation" },
                    { port: "Valencia", eta: "2025-11-25", etd: "2025-11-27", agent: "Transmed Logi", comments: "Final port of call" }
                ]
            },
            {
                name: "Maersk Helsinki",
                imo: "9675834",
                status: "Port Stay (Loading)",
                destination: "Port Klang, Malaysia",
                itinerary: [
                    { port: "Rotterdam", eta: "2025-11-08", etd: "2025-11-10", agent: "North Sea Agents", comments: "Currently loading sensitive cargo" },
                    { port: "Hamburg", eta: "2025-11-11", etd: "2025-11-12", agent: "Elbe Ship Mgmt", comments: "Minor engine maintenance" },
                    { port: "Suez Canal", eta: "2025-11-17", etd: "2025-11-17", agent: "Canal Transit Auth", comments: "Northbound transit" },
                    { port: "Colombo", eta: "2025-11-25", etd: "2025-11-26", agent: "Asia Logistics", comments: "Water and provisioning" },
                    { port: "Port Klang", eta: "2025-11-30", etd: "2025-12-02", agent: "Ocean Hub", comments: "Full discharge" }
                ]
            },
            {
                name: "CMA CGM Titan",
                imo: "9901523",
                status: "Anchored (Waiting Pilot)",
                destination: "New York, USA",
                itinerary: [
                    { port: "Southampton", eta: "2025-11-07", etd: "2025-11-08", agent: "Channel Ports", comments: "Delayed due to fog" },
                    { port: "Le Havre", eta: "2025-11-09", etd: "2025-11-11", agent: "Atlantic Agents", comments: "High volume of refrigerated cargo" },
                    { port: "Halifax", eta: "2025-11-18", etd: "2025-11-19", agent: "Maritime Services", comments: "Quick stop for consumables" },
                    { port: "New York", eta: "2025-11-22", etd: "2025-11-25", agent: "Big Apple Agents", comments: "Arrived but waiting for tidal window" },
                    { port: "Savannah", eta: "2025-11-27", etd: "2025-11-29", agent: "Southern Ports", comments: "Expected berth slot 14" }
                ]
            },
            {
                name: "Hapag-Lloyd Echo",
                imo: "9512040",
                status: "At Sea (Pacific Crossing)",
                destination: "Tokyo, Japan",
                itinerary: [
                    { port: "Long Beach", eta: "2025-11-05", etd: "2025-11-07", agent: "West Coast Lines", comments: "Sailed on schedule" },
                    { port: "Mid-Pacific", eta: "2025-11-15", etd: "2025-11-15", agent: "N/A", comments: "Scheduled crew drill" },
                    { port: "Yokohama", eta: "2025-11-23", etd: "2025-11-25", agent: "Kanto Marine", comments: "Hazardous goods clearance required" },
                    { port: "Kobe", eta: "2025-11-26", etd: "2025-11-27", agent: "Kansai Agents", comments: "Minor hull inspection" },
                    { port: "Tokyo", eta: "2025-11-28", etd: "2025-11-30", agent: "Eastern Ports", comments: "Delayed one day due to weather" }
                ]
            },
            {
                name: "COSCO Universe",
                imo: "9781881",
                status: "Port Stay (Discharging)",
                destination: "Singapore",
                itinerary: [
                    { port: "Shanghai", eta: "2025-11-01", etd: "2025-11-04", agent: "Yangtze Maritime", comments: "Heavy lift operation complete" },
                    { port: "Hong Kong", eta: "2025-11-05", etd: "2025-11-06", agent: "Pearl River Ship", comments: "Fresh water uptake" },
                    { port: "Ho Chi Minh", eta: "2025-11-09", etd: "2025-11-10", agent: "Viet Port Mgmt", comments: "Discharge started (12 hours behind schedule)" },
                    { port: "Singapore", eta: "2025-11-13", etd: "2025-11-15", agent: "Lion City Ship", comments: "Main Hub Transhipment" },
                    { port: "Tanjung Priok", eta: "2025-11-17", etd: "2025-11-18", agent: "Indo Marine", comments: "Reefer container checks" }
                ]
            }
        ];


        // --- CORE FUNCTIONS ---
        
        /**
         * Attempts to unlock the itinerary for a given ship IMO using the current key.
         * @param {string} imo - The IMO number of the ship.
         */
        function checkPassword(imo) {
            const currentKey = window.currentEditKey; // Use the globally managed key
            const inputField = document.getElementById(`password-input-edit-${imo}`);
            const messageElement = document.getElementById(`password-message-edit-${imo}`);
            
            if (inputField.value === currentKey) {
                window.unlockedShips[imo] = true;
                messageElement.textContent = 'Unlocked! Itinerary is now editable.';
                messageElement.className = 'text-green-400 font-semibold';
                
                // Pass the IMO to renderShipList so it knows to keep this row open.
                // Re-render the list to switch from view-only content to input fields
                setTimeout(() => window.renderShipList(imo), 300); 

            } else {
                messageElement.textContent = `Incorrect key. The current key is "${currentKey}".`;
                messageElement.className = 'text-red-400 font-semibold';
                inputField.value = ''; // Clear input on failure
            }
        }

        /**
         * Gathers the data from the editable fields and UPDATES THE FIRESTORE DOCUMENT.
         * @param {string} imo - The IMO number of the ship being saved.
         */
        async function saveItinerary(imo) {
            if (!window.db || !window.appId || !window.doc || !window.setDoc) {
                window.alertUser('error', 'Database connection not ready.');
                return;
            }
            
            const shipIndex = window.shipData.findIndex(s => s.imo === imo);
            if (shipIndex === -1) return;

            const shipName = window.shipData[shipIndex].name;
            const updatedItinerary = [];
            const fields = ['port', 'eta', 'etd', 'agent', 'comments'];

            // Find all rows in the editable table for this ship
            const itineraryRows = document.querySelectorAll(`#itinerary-table-${imo} tbody tr`);
            
            itineraryRows.forEach((row, rowIndex) => {
                const newStop = {};
                fields.forEach(field => {
                    const input = row.querySelector(`#input-${imo}-row-${rowIndex}-${field}`);
                    if (input) {
                        newStop[field] = input.value;
                    }
                });
                updatedItinerary.push(newStop);
            });

            // Prepare the data structure for Firestore update
            const updatedShipData = {
                itinerary: updatedItinerary,
                lastUpdated: new Date().toISOString()
            };

            try {
                const { db, appId } = window;
                // Use globally exposed doc and setDoc
                const docRef = window.doc(db, `artifacts/${appId}/public/data/vessels`, imo);
                
                await window.setDoc(docRef, updatedShipData, { merge: true });
                
                window.alertUser('success', `Itinerary for ${shipName} saved successfully to the database!`);
                
                // Lock the editing mode after saving
                delete window.unlockedShips[imo];
                
                // The onSnapshot listener will automatically trigger renderShipList()
            } catch (error) {
                console.error("Error saving itinerary to Firestore:", error);
                window.alertUser('error', `Failed to save changes for ${shipName}. See console.`);
            }
        }

        /**
         * Renders a custom message box instead of alert()
         * @param {string} type - 'success' or 'error'
         * @param {string} message - The message to display
         */
        window.alertUser = function(type, message) {
            let messageBox = document.getElementById('status-message-box');

            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = 'status-message-box';
                messageBox.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-2xl z-50 transition-opacity duration-300';
                document.body.appendChild(messageBox);
            }

            const bgColor = type === 'success' ? 'bg-green-700' : 'bg-red-700';
            messageBox.className = `fixed top-4 right-4 p-4 rounded-lg shadow-2xl z-50 transition-opacity duration-300 ${bgColor} text-white opacity-100`;
            messageBox.innerHTML = `<p class="font-bold">${type.toUpperCase()}:</p><p>${message}</p>`;

            // Auto-hide after 3 seconds
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
            }, 3000);
            
            messageBox.classList.remove('opacity-0');
            messageBox.classList.add('opacity-100');
        }

        /**
         * Generates the itinerary content including the view-only table or editable inputs.
         */
        function renderItineraryContent(ship, isUnlocked) {
            const itineraryDiv = document.createElement('div');
            itineraryDiv.className = 'itinerary-container';

            // --- 1. Control Panel (Unlock/Save) ---
            if (isUnlocked) {
                // RENDER ONLY THE MESSAGE AND HR
                itineraryDiv.innerHTML += `
                    <p class="text-sm text-green-400 font-semibold mb-3">
                        Editing Mode Unlocked.
                    </p>
                    <hr class="my-4 border-gray-600"> <!-- Darker HR -->
                `;
            } else {
                // RENDER UNLOCK PROMPT
                const currentKey = window.currentEditKey; // Get the current key for display
                itineraryDiv.innerHTML += `
                    <div id="unlock-ui-${ship.imo}">
                        <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
                            <p class="text-sm text-gray-200 font-medium">
                                Viewing Itinerary. Click unlock to edit.
                            </p>
                            <button id="show-unlock-${ship.imo}" onclick="document.getElementById('password-box-${ship.imo}').classList.toggle('hidden'); this.classList.add('hidden');" class="bg-yellow-600 text-white px-4 py-2 text-sm rounded-lg font-semibold hover:bg-yellow-500 transition duration-150 shadow-sm">
                                Unlock for Editing
                            </button>
                        </div>

                        <!-- Hidden Password Input Box -->
                        <div id="password-box-${ship.imo}" class="password-prompt-small hidden p-3 mb-4">
                            <input type="password" id="password-input-edit-${ship.imo}" placeholder="Enter current key (${currentKey})" class="px-3 py-1 text-sm flex-grow rounded-lg focus:ring-indigo-500 focus:border-indigo-500" onkeydown="if(event.keyCode===13) { checkPassword('${ship.imo}') }">
                            <button onclick="checkPassword('${ship.imo}')" class="bg-indigo-600 text-white px-4 py-1 text-sm rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">
                                Submit
                            </button>
                            <p id="password-message-edit-${ship.imo}" class="mt-1 text-xs h-5 w-full"></p>
                        </div>
                    </div>
                `;
            }

            // --- 2. Itinerary Table ---
            const table = document.createElement('table');
            table.id = `itinerary-table-${ship.imo}`;
            table.className = 'itinerary-table w-full border-collapse';

            // Table Header (Desktop only)
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr class="hidden md:table-row rounded-t-lg">
                    <th class="rounded-tl-lg">Port Name</th>
                    <th>ETA</th>
                    <th>ETD</th>
                    <th>Agent Name</th>
                    <th class="rounded-tr-lg">Comments</th>
                </tr>
            `;
            
            // Table Body (View or Editable Content)
            const tbody = document.createElement('tbody');
            // Ensure itinerary is an array before trying to iterate
            const itinerary = Array.isArray(ship.itinerary) ? ship.itinerary : [];
            itinerary.forEach((item, index) => {
                const row = document.createElement('tr');
                const fields = ['port', 'eta', 'etd', 'agent', 'comments'];

                row.innerHTML = fields.map(field => {
                    // Use a fallback for null/undefined values
                    const value = item[field] || ''; 
                    if (isUnlocked) {
                        return `
                            <td data-label="${field.toUpperCase()}">
                                <input type="text" value="${value}" id="input-${ship.imo}-row-${index}-${field}" class="text-sm">
                            </td>
                        `;
                    } else {
                        return `
                            <td data-label="${field.toUpperCase()}">
                                <span class="text-sm">${value}</span>
                            </td>
                        `;
                    }
                }).join('');

                tbody.appendChild(row);
            });

            table.appendChild(thead);
            table.appendChild(tbody);
            itineraryDiv.appendChild(table);

            // --- 3. Bottom Save Button (Kept) ---
            if (isUnlocked) {
                const saveButtonBottom = document.createElement('button');
                saveButtonBottom.onclick = () => saveItinerary(ship.imo);
                saveButtonBottom.className = 'w-full md:w-auto mt-4 px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-150';
                saveButtonBottom.textContent = 'Save Changes (To Database)';
                itineraryDiv.appendChild(saveButtonBottom);
            }

            return itineraryDiv;
        }

        /**
         * Renders the main ship list and the collapsible itineraries.
         * Exposed globally as it's called by the onSnapshot listener.
         * @param {string | null} imoToKeepOpen - The IMO of the ship whose details should remain open.
         */
        window.renderShipList = function(imoToKeepOpen = null) {
            const listContainer = document.getElementById('ship-list');
            listContainer.innerHTML = ''; // Clear content
            window.lastOpenImo = imoToKeepOpen; // Remember the last one that was intentionally open

            if (window.shipData.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-400">No vessel data loaded or found in the database.</p>';
                return;
            }

            window.shipData.forEach(ship => {
                const isUnlocked = window.unlockedShips[ship.imo];
                const statusColor = ship.status.includes('At Sea') ? 'bg-blue-900/50 text-blue-300' :
                                    ship.status.includes('Port Stay') ? 'bg-green-900/50 text-green-300' :
                                    'bg-yellow-900/50 text-yellow-300';

                // --- 1. Create the Collapsible Ship Row (details tag) ---
                const details = document.createElement('details');
                details.className = 'ship-row';

                // FIX: Set the 'open' attribute if this is the ship we need to keep open
                if (ship.imo === imoToKeepOpen) {
                    details.open = true;
                }
                
                // Add event listener to capture when a row is manually closed/opened
                details.addEventListener('toggle', () => {
                    if (details.open) {
                        window.lastOpenImo = ship.imo;
                    } else if (window.lastOpenImo === ship.imo) {
                        // Clear the tracked IMO if the user closes it manually
                        window.lastOpenImo = null;
                    }
                });


                // --- 2. Create the Summary (Ship Header) ---
                const summary = document.createElement('summary');
                summary.innerHTML = `
                    <div class="flex-grow grid grid-cols-4 gap-4 items-center text-sm md:text-base">
                        <!-- Ship Name -->
                        <div class="col-span-4 md:col-span-1 flex items-center">
                            <svg class="w-5 h-5 mr-3 text-indigo-400 hidden md:block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                            <span class="font-bold text-lg text-indigo-300">${ship.name}</span>
                        </div>
                        <!-- Status Badge -->
                        <div class="col-span-2 md:col-span-1">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColor} whitespace-nowrap" >
                                ${ship.status} ${isUnlocked ? '(EDIT MODE)' : ''}
                            </span>
                        </div>
                        <!-- Destination -->
                        <div class="col-span-2 md:col-span-1 text-gray-400 truncate" title="Destination: ${ship.destination}">
                            <span class="hidden md:inline">Dest:</span> ${ship.destination}
                        </div>
                        <!-- IMO (on Mobile, this replaces Destination) -->
                        <div class="col-span-4 md:col-span-1 text-gray-500 text-xs md:text-sm pt-1 md:pt-0">
                            IMO: ${ship.imo}
                        </div>
                    </div>
                `;

                // --- 3. Create the Itinerary Content (View-only by default) ---
                const itineraryContent = renderItineraryContent(ship, isUnlocked);
                
                // --- 4. Assemble the final structure ---
                details.appendChild(summary);
                details.appendChild(itineraryContent);
                listContainer.appendChild(details);
            });
        }

        // --- NEW PAGE/VIEW FUNCTIONS ---
        
        // Function to change the local editing key
        function changeLocalEditKey() {
            const input = document.getElementById('new-key-input');
            const message = document.getElementById('key-change-message');
            const newKey = input.value.trim();

            if (newKey.length === 5 && /^\d+$/.test(newKey)) {
                window.currentEditKey = newKey; // Update the globally accessible key
                document.getElementById('display-local-key').textContent = newKey;
                message.textContent = `Success! Key changed to ${newKey}.`;
                message.className = 'mt-2 text-sm text-green-400 font-semibold';
                input.value = ''; // Clear input
            } else {
                message.textContent = 'Invalid key. Must be exactly 5 digits.';
                message.className = 'mt-2 text-sm text-red-400 font-semibold';
            }
        }
        
        /**
         * Function to reset all ship data to the initial state in the database.
         * It uses a Firestore batch write for efficiency.
         */
        async function resetShipData() {
            // Ensure all necessary globals are available
            if (!window.db || !window.appId || !window.doc || !window.writeBatch) {
                window.alertUser('error', 'Database connection not fully ready. Try again in a moment.');
                return;
            }

            try {
                const { db, appId } = window;
                // Use the globally exposed writeBatch function
                const batch = window.writeBatch(db);
                const dataPath = `artifacts/${appId}/public/data/vessels`;

                originalShipData.forEach(ship => {
                    // Use the globally exposed doc function
                    const docRef = window.doc(db, dataPath, ship.imo);
                    // Add the entire ship object to the batch
                    batch.set(docRef, ship);
                });

                await batch.commit();

                // Clear any in-memory unlocks
                Object.keys(window.unlockedShips).forEach(key => delete window.unlockedShips[key]);
                window.alertUser('success', 'All ship data reset to default and saved to database!');
                
                // The onSnapshot listener will handle the UI update automatically
            } catch (error) {
                console.error("Error resetting ship data:", error);
                window.alertUser('error', 'Failed to reset data in the database.');
            }
        }


        /**
         * Updates the navigation tabs to highlight the active page.
         * @param {string} pageName - The page to highlight ('position-list' or 'settings').
         */
        function updateNavStyling(pageName) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('text-indigo-400', 'border-indigo-500');
                tab.classList.add('text-gray-500', 'hover:text-gray-300');
                tab.style.borderBottomWidth = '0'; 
            });
            
            const activeTab = document.getElementById(`nav-${pageName}`);
            if (activeTab) {
                activeTab.classList.remove('text-gray-500', 'hover:text-gray-300');
                activeTab.classList.add('text-indigo-400');
                activeTab.style.borderBottomWidth = '2px';
            }
        }


        /**
         * Switches the active view/page (Position List or Settings).
         * @param {string} pageName - 'position-list' or 'settings'.
         */
        function switchView(pageName) {
            // Check if we are already on this page
            if (window.currentPage === pageName) {
                updateNavStyling(pageName);
                return; 
            }

            const positionView = document.getElementById('position-list-view');
            const settingsView = document.getElementById('settings-view');
            
            // Set the new current page
            window.currentPage = pageName;

            // --- Hide/Show Views & Render Content ---
            if (pageName === 'position-list') {
                positionView.classList.remove('hidden');
                settingsView.classList.add('hidden');
                // Call renderShipList to display current database data
                window.renderShipList(window.lastOpenImo); 
            } else {
                positionView.classList.add('hidden');
                settingsView.classList.remove('hidden');
                // Update the displayed key on the settings page
                document.getElementById('display-local-key').textContent = window.currentEditKey;
            }

            // --- Update Navigation Styling ---
            updateNavStyling(pageName);
        }

        // Run the rendering function when the window loads
        window.onload = function() {
            // Start the application on the 'position-list' view
            // The Firebase setup handles the data loading
            switchView('position-list'); 
        }
    </script>
</body>
</html>
